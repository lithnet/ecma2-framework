<?xml version="1.0" encoding="utf-8" ?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
	<Target Name="ILRepacker" AfterTargets="Build">

		<ItemGroup>
			<InputAssemblies Include="$(OutputPath)\*.dll" />
		</ItemGroup>

		<ItemGroup>
			<LibraryPaths Include="$(OutputPath)" />
			<LibraryPaths Include="@(ReferencePathWithRefAssemblies)" />
		</ItemGroup>

		<ItemGroup>
			<DoNotInternalizeAssemblies Include="Lithnet.Ecma2Framework" />
		</ItemGroup>

		<Message Text="MERGING: @(InputAssemblies->'%(Filename)') into $(OutputAssembly)" Importance="High" />
		<ILRepack Parallel="true" Internalize="true" DebugInfo="true" InternalizeExclude="@(DoNotInternalizeAssemblies)" InputAssemblies="@(InputAssemblies)" TargetKind="Dll" OutputFile="$(OutputPath)\$(AssemblyName).dll" LibraryPath="@(LibraryPaths)" />
	</Target>

	<Target AfterTargets="ILRepacker"
				Name="CleanReferenceCopyLocalPaths"
				Condition="'$(ClearOutputDirectory)' != 'False'">
		<Delete Files="@(ReferenceCopyLocalPaths->'$(OutDir)%(DestinationSubDirectory)%(Filename)%(Extension)')" />
		<ItemGroup>
			<Directories Include="$([System.IO.Directory]::GetDirectories('$(OutDir)%(DestinationSubDirectory)', '*', System.IO.SearchOption.AllDirectories))" />
			<Directories>
				<Files>$([System.IO.Directory]::GetFiles("%(Directories.Identity)", "*", System.IO.SearchOption.AllDirectories).get_Length())</Files>
			</Directories>
		</ItemGroup>
		<RemoveDir Directories="@(Directories)" Condition="%(Files)=='0'" />
	</Target>
</Project>

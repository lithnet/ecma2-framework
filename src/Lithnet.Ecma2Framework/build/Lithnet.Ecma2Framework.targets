<?xml version="1.0" encoding="utf-8" ?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
	<Import Project="$(ProjectDir)ILRepack.Config.props" Condition="Exists('$(ProjectDir)ILRepack.Config.props')" />

	<PropertyGroup>
		<ILRepackTargetsFile Condition="$(ILRepackTargetsFile) == ''">$(ProjectDir)ILRepack.targets</ILRepackTargetsFile>
	</PropertyGroup>

	<UsingTask AssemblyFile="$(MSBuildThisFileDirectory)ILRepack.Lib.MSBuild.Task.dll" TaskName="ILRepack" />

	<Import Project="$(ILRepackTargetsFile)" Condition="Exists('$(ILRepackTargetsFile)')" />

	<Target Name="ILRepacker" AfterTargets="Build"  Condition="!Exists('$(ILRepackTargetsFile)')">

		<ItemGroup>
			<InputAssemblies Include="$(OutputPath)$(TargetName)$(TargetExt)"/>
			<InputAssemblies Include="$(OutputPath)*.dll" Exclude="$(OutputPath)$(TargetName)$(TargetExt)"/>
		</ItemGroup>

		<ItemGroup>
			<LibraryPaths Include="$(OutputPath)" />
			<LibraryPaths Include="@(ReferencePathWithRefAssemblies)" />
		</ItemGroup>

		<ItemGroup>
			<DoNotInternalizeAssemblies Include="Lithnet.Ecma2Framework" />
		</ItemGroup>

		<Message Text="MERGING: @(InputAssemblies->'%(Filename)') into $(OutputPath)$(TargetName)$(TargetExt)" Importance="High" />
		<ILRepack Parallel="true"
				  Internalize="true"
				  DebugInfo="true"
				  InternalizeExclude="@(DoNotInternalizeAssemblies)"
				  InputAssemblies="@(InputAssemblies)"
				  TargetKind="SameAsPrimaryAssembly"
				  OutputFile="$(OutputPath)$(TargetName)$(TargetExt)"
				  LibraryPath="@(LibraryPaths)" />
	</Target>

	<Target AfterTargets="ILRepacker"
				Name="CleanReferenceCopyLocalPaths"
				Condition="'$(ClearOutputDirectory)' != 'False' and !Exists('$(ILRepackTargetsFile)')">
		<Delete Files="@(ReferenceCopyLocalPaths->'$(OutDir)%(DestinationSubDirectory)%(Filename)%(Extension)')" />
		<ItemGroup>
			<Directories Include="$([System.IO.Directory]::GetDirectories('$(OutDir)%(DestinationSubDirectory)', '*', System.IO.SearchOption.AllDirectories))" />
			<Directories>
				<Files>$([System.IO.Directory]::GetFiles("%(Directories.Identity)", "*", System.IO.SearchOption.AllDirectories).get_Length())</Files>
			</Directories>
		</ItemGroup>
		<RemoveDir Directories="@(Directories)" Condition="%(Files)=='0'" />
	</Target>
</Project>
